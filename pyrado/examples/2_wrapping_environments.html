<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to wrap an environment &mdash; Pyrado 0.7.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to create an algorithm" href="3_algorithm_skeleton.html" />
    <link rel="prev" title="How to run an experiment" href="1_basic_experiment.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Pyrado
          </a>
              <div class="version">
                0.7.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Examples:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_basic_experiment.html">How to run an experiment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to wrap an environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_algorithm_skeleton.html">How to create an algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_creating_rcspysim_environments.html">How to create an RcsPySim environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_panda3d_visualization.html"><strong>How to create a visualization</strong></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environments:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../environments.html">environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environments.barrett_wam.html">barrett_wam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environments.mujoco.html">mujoco</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environments.pysim.html">pysim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environments.quanser.html">quanser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environments.rcspysim.html">rcspysim</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Environment Wrappers:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../environment_wrappers.html">environment_wrappers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Domain Randomization:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../domain_randomization.html">domain_randomization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Algorithms:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.html">algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.episodic.html">episodic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.step_based.html">step_based</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.meta.html">meta</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.regression.html">regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithms.stopping_criteria.html">stopping_criteria</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Exploration:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../exploration.html">exploration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Policies:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../policies.html">policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policies.feed_back.html">feed_back</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policies.feed_forward.html">feed_forward</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policies.recurrent.html">recurrent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../policies.special.html">special</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Spaces:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../spaces.html">spaces</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tasks &amp; Rewards:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tasks.html">tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Sampling:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sampling.html">sampling</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plotting:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plotting.html">plotting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Utilities:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pyrado</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">How to wrap an environment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/2_wrapping_environments.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-to-wrap-an-environment">
<h1>How to wrap an environment<a class="headerlink" href="#how-to-wrap-an-environment" title="Permalink to this heading"></a></h1>
<p>Let’s first create the basic simulator without any wrappers</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">prettyprinter</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="kn">from</span> <span class="nn">pyrado.domain_randomization.default_randomizers</span> <span class="kn">import</span> <span class="n">create_default_randomizer</span>
<span class="kn">from</span> <span class="nn">pyrado.environment_wrappers.action_delay</span> <span class="kn">import</span> <span class="n">ActDelayWrapper</span>
<span class="kn">from</span> <span class="nn">pyrado.environment_wrappers.action_noise</span> <span class="kn">import</span> <span class="n">GaussianActNoiseWrapper</span>
<span class="kn">from</span> <span class="nn">pyrado.environment_wrappers.action_normalization</span> <span class="kn">import</span> <span class="n">ActNormWrapper</span>
<span class="kn">from</span> <span class="nn">pyrado.environment_wrappers.domain_randomization</span> <span class="kn">import</span> <span class="n">DomainRandWrapperBuffer</span>
<span class="kn">from</span> <span class="nn">pyrado.environment_wrappers.observation_normalization</span> <span class="kn">import</span> <span class="n">ObsNormWrapper</span>
<span class="kn">from</span> <span class="nn">pyrado.environment_wrappers.observation_partial</span> <span class="kn">import</span> <span class="n">ObsPartialWrapper</span>
<span class="kn">from</span> <span class="nn">pyrado.environment_wrappers.utils</span> <span class="kn">import</span> <span class="n">inner_env</span><span class="p">,</span> <span class="n">remove_env</span><span class="p">,</span> <span class="n">typed_env</span>
<span class="kn">from</span> <span class="nn">pyrado.environments.pysim.quanser_cartpole</span> <span class="kn">import</span> <span class="n">QCartPoleSwingUpSim</span>
<span class="kn">from</span> <span class="nn">pyrado.policies.special.dummy</span> <span class="kn">import</span> <span class="n">DummyPolicy</span>
<span class="kn">from</span> <span class="nn">pyrado.sampling.rollout</span> <span class="kn">import</span> <span class="n">rollout</span>
<span class="kn">from</span> <span class="nn">pyrado.utils.data_types</span> <span class="kn">import</span> <span class="n">RenderMode</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">QCartPoleSwingUpSim</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mf">50.</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dim obs: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">obs_space</span><span class="o">.</span><span class="n">flat_dim</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
      <span class="sa">f</span><span class="s1">&#39;dim state: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">state_space</span><span class="o">.</span><span class="n">flat_dim</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
      <span class="sa">f</span><span class="s1">&#39;dim act: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">act_space</span><span class="o">.</span><span class="n">flat_dim</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The print reveals that we have a 4-dimensional sate space, a 5-dimensional observation space, and a 1-dimensional
action space, all of type <cite>BoxSpace</cite> which is a straightforward continuous space in <span class="math notranslate nohighlight">\(R^n\)</span>.
Since we are probably here to do some domain randomization, we will start with that.
There are different types of randomizers. The <cite>DomainRandWrapperLive</cite> sets a new set of domain parameters on every
reset of the environment. The <cite>DomainRandWrapperBuffer</cite> maintains a buffer of domain parameter set which we have to
fill explicitly. This way, it cycles through a set of domains. There is also the <cite>MetaDomainRandWrapper</cite> which
adapts the randomizer, i.e. changes the distribution according to which the domain parameters are randomized.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">randomizer</span> <span class="o">=</span> <span class="n">create_default_randomizer</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">randomizer</span><span class="p">)</span>
<span class="n">env_r</span> <span class="o">=</span> <span class="n">DomainRandWrapperBuffer</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">randomizer</span><span class="p">)</span>
<span class="n">env_r</span><span class="o">.</span><span class="n">fill_buffer</span><span class="p">(</span><span class="n">num_domains</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s have a look at the randomized simulation. Due to the synchronized random seed we have the same initial state as
well as the same random action. However, the trajectory id not the same since the domains evolve differently.
Note that the very first action and reward are only different for logging.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">rollout</span><span class="p">(</span><span class="n">env_r</span><span class="p">,</span> <span class="n">DummyPolicy</span><span class="p">(</span><span class="n">env_r</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="n">RenderMode</span><span class="p">(</span><span class="n">video</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">domain_param</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>In general, the environments’ individual observation dimensions have very different scales and limits.
It is an open secret that one of the most important things for RL to work well are equally scaled actions and
observations. Thus we will scale these spaces to [-1, 1] for every dimension. Check the wrappers’ <cite>_process_act</cite> and
<cite>_process_obs</cite> functions for details. One observation dimension does not have a finite lime. Therefore we need to
provide and explicit limit for normalizing. We can also provide explicit bounds to override existing ones.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">env_r</span><span class="o">.</span><span class="n">act_space</span><span class="p">)</span>
<span class="n">env_rn</span> <span class="o">=</span> <span class="n">ActNormWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env_rn</span><span class="o">.</span><span class="n">act_space</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">env_rn</span><span class="o">.</span><span class="n">obs_space</span><span class="p">)</span>
<span class="n">elb</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_dot&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">213.</span><span class="p">,</span> <span class="s1">&#39;theta_dot&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">42.</span><span class="p">}</span>
<span class="n">eub</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_dot&#39;</span><span class="p">:</span> <span class="mf">213.</span><span class="p">,</span> <span class="s1">&#39;theta_dot&#39;</span><span class="p">:</span> <span class="mf">42.</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mf">0.123</span><span class="p">}</span>
<span class="n">env_rn</span> <span class="o">=</span> <span class="n">ObsNormWrapper</span><span class="p">(</span><span class="n">env_rn</span><span class="p">,</span> <span class="n">explicit_lb</span><span class="o">=</span><span class="n">elb</span><span class="p">,</span> <span class="n">explicit_ub</span><span class="o">=</span><span class="n">eub</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env_rn</span><span class="o">.</span><span class="n">obs_space</span><span class="p">)</span>
</pre></div>
</div>
<p>So if we now do a rollout, we can see the effect of the normalization</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ro_r</span> <span class="o">=</span> <span class="n">rollout</span><span class="p">(</span><span class="n">env_r</span><span class="p">,</span> <span class="n">DummyPolicy</span><span class="p">(</span><span class="n">env_r</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="n">RenderMode</span><span class="p">())</span>
<span class="n">ro_rn</span> <span class="o">=</span> <span class="n">rollout</span><span class="p">(</span><span class="n">env_rn</span><span class="p">,</span> <span class="n">DummyPolicy</span><span class="p">(</span><span class="n">env_rn</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="n">RenderMode</span><span class="p">())</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;observations without normalization:</span><span class="se">\n</span><span class="si">{</span><span class="n">ro_r</span><span class="o">.</span><span class="n">observations</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;observations with normalization:</span><span class="se">\n</span><span class="si">{</span><span class="n">ro_rn</span><span class="o">.</span><span class="n">observations</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">env_rn</span><span class="o">.</span><span class="n">_process_obs</span><span class="p">(</span><span class="n">ro_r</span><span class="o">.</span><span class="n">observations</span><span class="p">),</span> <span class="n">ro_rn</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span>
</pre></div>
</div>
<p>In case we want to mask some observations from wer policy, e.g. if the real system does not observe a quantity that is
available during simulation, we can mask them out using the <cite>ObsPartialWrapper</cite>. This wrapper can mask using an array
of zeros and ones, or by passing a list of the exact labels.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env_rnp</span> <span class="o">=</span> <span class="n">ObsPartialWrapper</span><span class="p">(</span><span class="n">env_rn</span><span class="p">,</span> <span class="n">idcs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_dot&#39;</span><span class="p">,</span> <span class="s1">&#39;cos_theta&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">env_rnp</span><span class="o">.</span><span class="n">obs_space</span><span class="p">)</span>
<span class="n">ro_rnp</span> <span class="o">=</span> <span class="n">rollout</span><span class="p">(</span><span class="n">env_rnp</span><span class="p">,</span> <span class="n">DummyPolicy</span><span class="p">(</span><span class="n">env_rnp</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="n">RenderMode</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;partial observations with normalization:</span><span class="se">\n</span><span class="si">{</span><span class="n">ro_rnp</span><span class="o">.</span><span class="n">observations</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also apply wrappers that apply additional noise to the action (<cite>GaussianActNoiseWrapper</cite>) or observations
(<cite>GaussianObsNoiseWrapper). The action wrappers will not modify the `action</cite> filed in the recorded rollout, since this
one is capturing the action as they are commanded by the policy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">env_rnpa</span> <span class="o">=</span> <span class="n">GaussianActNoiseWrapper</span><span class="p">(</span><span class="n">env_rnp</span><span class="p">,</span>
                                   <span class="n">noise_mean</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">env_rnp</span><span class="o">.</span><span class="n">act_space</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                                   <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">env_rnp</span><span class="o">.</span><span class="n">act_space</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
<span class="n">ro_rnpa</span> <span class="o">=</span> <span class="n">rollout</span><span class="p">(</span><span class="n">env_rnpa</span><span class="p">,</span> <span class="n">DummyPolicy</span><span class="p">(</span><span class="n">env_rnpa</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="n">RenderMode</span><span class="p">())</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ro_rnp</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span> <span class="n">ro_rnpa</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ro_rnp</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">ro_rnpa</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span>
</pre></div>
</div>
<p>Real-world devices often have delays. One way to model this effect is by artificially hold back the current action for
a given number of time steps. Again, the modified <cite>action</cite> fields in the recorded rollouts are the same. Have a look at
the printed actions <cite>a_t</cite> as well as next state <cite>s_t+1</cite></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ro_rnp</span> <span class="o">=</span> <span class="n">rollout</span><span class="p">(</span><span class="n">env_rnp</span><span class="p">,</span> <span class="n">DummyPolicy</span><span class="p">(</span><span class="n">env_rnp</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="n">RenderMode</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>  <span class="c1"># redo for visual comparison</span>
<span class="n">env_rnpd</span> <span class="o">=</span> <span class="n">ActDelayWrapper</span><span class="p">(</span><span class="n">env_rnp</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ro_rnpd</span> <span class="o">=</span> <span class="n">rollout</span><span class="p">(</span><span class="n">env_rnpd</span><span class="p">,</span> <span class="n">DummyPolicy</span><span class="p">(</span><span class="n">env_rnpd</span><span class="o">.</span><span class="n">spec</span><span class="p">),</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">render_mode</span><span class="o">=</span><span class="n">RenderMode</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ro_rnp</span><span class="o">.</span><span class="n">actions</span><span class="p">,</span> <span class="n">ro_rnpd</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ro_rnp</span><span class="o">.</span><span class="n">observations</span><span class="p">,</span> <span class="n">ro_rnpd</span><span class="o">.</span><span class="n">observations</span><span class="p">)</span>
</pre></div>
</div>
<p>There are also very handy utils to manage chains of wrappers. Examples are`inner_env()` which yields the core
environment, <cite>typed_env()</cite> which yields the first element of the chain equal to the provided type, or <cite>remove_env</cite> which
removes the first element of the chain equal to the provided type.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inner_env</span><span class="p">(</span><span class="n">env_rnpd</span><span class="p">),</span> <span class="n">QCartPoleSwingUpSim</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">typed_env</span><span class="p">(</span><span class="n">env_rnpd</span><span class="p">,</span> <span class="n">ObsPartialWrapper</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env_rnpd</span><span class="p">,</span> <span class="n">ActDelayWrapper</span><span class="p">)</span>
<span class="n">env_rnpdr</span> <span class="o">=</span> <span class="n">remove_env</span><span class="p">(</span><span class="n">env_rnpd</span><span class="p">,</span> <span class="n">ActDelayWrapper</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env_rnpdr</span><span class="p">,</span> <span class="n">ActDelayWrapper</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, <strong>the most important lesson</strong>: the order in which we apply the environment wrappers matters!
For example, applying the <cite>ObsNormWrapper</cite> after the <cite>ObsPartialWrapper</cite> will not give we the intended result (due to
the implementation). Another example is the order of <cite>ObsNormWrapper</cite> and <cite>GaussianObsNoiseWrapper</cite>.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="1_basic_experiment.html" class="btn btn-neutral float-left" title="How to run an experiment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="3_algorithm_skeleton.html" class="btn btn-neutral float-right" title="How to create an algorithm" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>